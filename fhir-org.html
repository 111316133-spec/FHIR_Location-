<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Organization 產生器 (連結 Location)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .status-box { margin-top: 20px; }
        .ref-box { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 5px solid #0d6efd; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-primary">FHIR Organization</h2>
    <p class="text-muted">建立組織並參照到地點 (Location)</p>
    <hr>

    <form id="fhirForm">
        <h5 class="mb-3">1. 組織資訊</h5>
        <div class="mb-3">
            <label for="orgName" class="form-label">組織名稱 (Name)</label>
            <input type="text" class="form-control" id="orgName" placeholder="例如：慈濟大學" required>
        </div>
        <div class="mb-3">
            <label for="orgType" class="form-label">組織類型 (Type)</label>
            <select class="form-select" id="orgType">
                <option value="prov">Healthcare Provider (醫療提供者)</option>
                <option value="dept">Hospital Department (科室)</option>
                <option value="edu" selected>Educational Institute (教育機構)</option>
                <option value="other">Other (其他)</option>
            </select>
        </div>

        <div class="ref-box">
            <h5 class="mb-3">2. 連結地點 (Location Reference)</h5>
            <label for="locationUuid" class="form-label">Location UUID</label>
            <input type="text" class="form-control" id="locationUuid" placeholder="請貼上剛才產生的 Location UUID" required>
            <div class="form-text">程式將建立參照：<code>Organization -> extension -> Reference(Location/{uuid})</code></div>
        </div>

        <h5 class="mb-3">3. 設定 ID (Client Assigned ID)</h5>
        <div class="mb-3">
            <label for="uuidDisplay" class="form-label">Organization Resource ID (UUID)</label>
            <div class="input-group">
                <input type="text" class="form-control" id="uuidDisplay" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="generateNewUUID()">重新產生</button>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 btn-lg">建立組織 (HTTP PUT)</button>
    </form>

    <div id="resultArea" class="status-box d-none">
        <h4 class="mt-4">執行結果</h4>
        <div id="alertBox" class="alert" role="alert"></div>
        
        <h5>傳送的 FHIR JSON (包含 Extension):</h5>
        <pre id="jsonPreview"></pre>
        
        <h5>伺服器回應:</h5>
        <pre id="serverResponse"></pre>
    </div>
</div>

<script>
    const FHIR_BASE_URL = "https://hapi.fhir.org/baseR4";

    // 初始化產生 UUID
    window.onload = function() {
        generateNewUUID();
    };

    function generateNewUUID() {
        document.getElementById('uuidDisplay').value = crypto.randomUUID();
    }

    document.getElementById('fhirForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // 1. 收集資料
        const orgId = document.getElementById('uuidDisplay').value;
        const name = document.getElementById('orgName').value;
        const type = document.getElementById('orgType').value;
        const locationId = document.getElementById('locationUuid').value.trim();

        // 2. 建構 FHIR Organization Resource
        // 由於標準 Organization 沒有 location 欄位，我們使用 extension 進行參照
        const fhirResource = {
            "resourceType": "Organization",
            "id": orgId,
            "active": true,
            "name": name,
            "type": [
                {
                    "coding": [
                        {
                            "system": "http://terminology.hl7.org/CodeSystem/organization-type",
                            "code": type
                        }
                    ]
                }
            ],
            // 使用 Extension 來連結 Location
            "extension": [
                {
                    "url": "http://example.org/fhir/StructureDefinition/organization-location-reference",
                    "valueReference": {
                        "reference": `Location/${locationId}`,
                        "display": "關聯地點"
                    }
                }
            ]
        };

        // 顯示預覽
        const resultArea = document.getElementById('resultArea');
        const alertBox = document.getElementById('alertBox');
        const jsonPreview = document.getElementById('jsonPreview');
        const serverResponse = document.getElementById('serverResponse');
        
        resultArea.classList.remove('d-none');
        jsonPreview.textContent = JSON.stringify(fhirResource, null, 2);
        alertBox.className = 'alert alert-info';
        alertBox.textContent = '正在上傳中...';
        serverResponse.textContent = '';

        // 3. 發送 HTTP PUT 請求
        try {
            const url = `${FHIR_BASE_URL}/Organization/${orgId}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/fhir+json'
                },
                body: JSON.stringify(fhirResource)
            });

            const data = await response.json();
            serverResponse.textContent = JSON.stringify(data, null, 2);

            if (response.ok) {
                alertBox.className = 'alert alert-success';
                alertBox.innerHTML = `<strong>成功！</strong> Organization 已建立。<br>Resource URL: <a href="${url}" target="_blank">${url}</a><br>參照了 Location: ${locationId}`;
            } else {
                throw new Error(data.issue ? data.issue[0].diagnostics : response.statusText);
            }

        } catch (error) {
            alertBox.className = 'alert alert-danger';
            alertBox.textContent = '發生錯誤: ' + error.message;
            serverResponse.textContent = error.stack || error;
        }
    });
</script>

</body>
</html>