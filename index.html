<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Location ç”¢ç”Ÿå™¨ (Client Assigned ID)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .status-box { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-primary">FHIR Location ç”¢ç”Ÿå™¨</h2>
    <p class="text-muted">ç›®æ¨™ä¼ºæœå™¨: <code>https://hapi.fhir.org/baseR4/</code></p>
    <hr>

    <form id="fhirForm">
        <div class="mb-3">
            <label for="locName" class="form-label">åœ°é»åç¨± (Location Name)</label>
            <input type="text" class="form-control" id="locName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—101å¤§æ¨“" required>
        </div>
        
        <div class="mb-3">
            <label for="locAddress" class="form-label">åœ°å€ (Address)</label>
            <input type="text" class="form-control" id="locAddress" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ" required>
        </div>

        <div class="row mb-3">
            <div class="col-md-5">
                <label for="latitude" class="form-label">ç·¯åº¦ (Latitude)</label>
                <input type="number" step="any" class="form-control" id="latitude" placeholder="25.0339" required>
            </div>
            <div class="col-md-5">
                <label for="longitude" class="form-label">ç¶“åº¦ (Longitude)</label>
                <input type="number" step="any" class="form-control" id="longitude" placeholder="121.5644" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="getBrowserLocation()">
                    ğŸ“ æŠ“å–ä½ç½®
                </button>
            </div>
        </div>

        <div class="mb-3">
            <label for="uuidDisplay" class="form-label">ç”Ÿæˆçš„ Resource ID (UUID)</label>
            <div class="input-group">
                <input type="text" class="form-control" id="uuidDisplay" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="generateNewUUID()">é‡æ–°ç”¢ç”Ÿ</button>
            </div>
            <div class="form-text">é€™å°‡ä½œç‚º HTTP PUT çš„ ID (Client Assigned ID)ã€‚</div>
        </div>

        <button type="submit" class="btn btn-primary w-100 btn-lg">ç”¢ç”Ÿä¸¦ä¸Šå‚³ (HTTP PUT)</button>
    </form>

    <div id="resultArea" class="status-box d-none">
        <h4 class="mt-4">åŸ·è¡Œçµæœ</h4>
        <div id="alertBox" class="alert" role="alert"></div>
        
        <h5>å‚³é€çš„ FHIR JSON:</h5>
        <pre id="jsonPreview"></pre>
        
        <h5>ä¼ºæœå™¨å›æ‡‰:</h5>
        <pre id="serverResponse"></pre>
    </div>
</div>

<script>
    const FHIR_BASE_URL = "https://hapi.fhir.org/baseR4";

    // åˆå§‹åŒ–æ™‚ç”¢ç”Ÿä¸€å€‹ UUID
    window.onload = function() {
        generateNewUUID();
    };

    // ç”¢ç”Ÿ UUID v4
    function generateNewUUID() {
        const uuid = crypto.randomUUID();
        document.getElementById('uuidDisplay').value = uuid;
    }

    // ç²å–ç€è¦½å™¨ç•¶å‰ä½ç½®
    function getBrowserLocation() {
        if (!navigator.geolocation) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½");
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
            },
            () => {
                alert("ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿã€‚");
            }
        );
    }

    // è¡¨å–®æäº¤è™•ç†
    document.getElementById('fhirForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // 1. æ”¶é›†è³‡æ–™
        const id = document.getElementById('uuidDisplay').value;
        const name = document.getElementById('locName').value;
        const address = document.getElementById('locAddress').value;
        const lat = parseFloat(document.getElementById('latitude').value);
        const long = parseFloat(document.getElementById('longitude').value);

        // 2. å»ºæ§‹ FHIR Location Resource (R4)
        const fhirResource = {
            "resourceType": "Location",
            "id": id,
            "status": "active",
            "name": name,
            "mode": "instance",
            "address": {
                "text": address
            },
            "position": {
                "latitude": lat,
                "longitude": long
            }
        };

        // é¡¯ç¤ºé è¦½
        const resultArea = document.getElementById('resultArea');
        const alertBox = document.getElementById('alertBox');
        const jsonPreview = document.getElementById('jsonPreview');
        const serverResponse = document.getElementById('serverResponse');
        
        resultArea.classList.remove('d-none');
        jsonPreview.textContent = JSON.stringify(fhirResource, null, 2);
        alertBox.className = 'alert alert-info';
        alertBox.textContent = 'æ­£åœ¨ä¸Šå‚³ä¸­...';
        serverResponse.textContent = '';

        // 3. ç™¼é€ HTTP PUT è«‹æ±‚
        try {
            const url = `${FHIR_BASE_URL}/Location/${id}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/fhir+json'
                },
                body: JSON.stringify(fhirResource)
            });

            const data = await response.json();
            serverResponse.textContent = JSON.stringify(data, null, 2);

            if (response.ok) {
                alertBox.className = 'alert alert-success';
                alertBox.innerHTML = `<strong>æˆåŠŸï¼</strong> Location å·²å»ºç«‹/æ›´æ–°ã€‚<br>Resource URL: <a href="${url}" target="_blank">${url}</a>`;
            } else {
                throw new Error(data.issue ? data.issue[0].diagnostics : response.statusText);
            }

        } catch (error) {
            alertBox.className = 'alert alert-danger';
            alertBox.textContent = 'ç™¼ç”ŸéŒ¯èª¤: ' + error.message;
            serverResponse.textContent = error.stack || error;
        }
    });
</script>

</body>
</html>