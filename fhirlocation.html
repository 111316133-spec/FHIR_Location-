<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR åœ°é»èˆ‡çµ„ç¹”è¨­ç«‹ç³»çµ± (æ¨™æº–é—œè¯)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f4f6f9; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; height: 100%; }
        .card-header { font-weight: bold; }
        .bg-org { background-color: #e3f2fd; color: #0d47a1; } /* è—è‰²ç³»: çµ„ç¹” */
        .bg-loc { background-color: #e8f5e9; color: #1b5e20; } /* ç¶ è‰²ç³»: åœ°é» */
        pre { background: #333; color: #fff; padding: 10px; border-radius: 5px; font-size: 0.85rem; max-height: 200px; overflow: auto; }
        .arrow-down { text-align: center; font-size: 2rem; color: #999; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">FHIR æ¨™æº–ä¹‹çµ„ç¹”èˆ‡åœ°é»çš„ç³»çµ±</h2>
   

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-org">å»ºç«‹çµ„ç¹” (Organization)</div>
                <div class="card-body">
                    <form id="orgForm">
                        <div class="mb-3">
                            <label class="form-label">çµ„ç¹”åç¨±</label>
                            <input type="text" class="form-control" id="orgName" value="" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">çµ„ç¹” UUID (Client ID)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="orgUuid" readonly>
                                <button class="btn btn-outline-primary" type="button" onclick="genUUID('orgUuid')">åˆ·æ–°</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">å»ºç«‹çµ„ç¹” (PUT)</button>
                    </form>
                    <div id="orgResult" class="mt-3 d-none">
                        <div class="alert alert-success py-2">çµ„ç¹”å»ºç«‹æˆåŠŸï¼ID å·²è‡ªå‹•è¤‡è£½åˆ°å³å´ã€‚</div>
                        <pre id="orgJson"></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-loc">å»ºç«‹åœ°é» (Location)</div>
                <div class="card-body">
                    <form id="locForm">
                        <div class="mb-3">
                            <label class="form-label">åœ°é»åç¨±</label>
                            <input type="text" class="form-control" id="locName" value="" required>
                        </div>
                        
                        <div class="mb-3 p-2 border border-success rounded bg-light">
                            <label class="form-label fw-bold text-success">ç®¡ç†å–®ä½ (Managing Organization)</label>
                            <input type="text" class="form-control" id="linkOrgUuid" placeholder="ç­‰å¾…æ­¥é©Ÿ 1 å®Œæˆ..." readonly required>
                            <div class="form-text">å°‡å¯«å…¥ <code>managingOrganization.reference</code></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç¶“ç·¯åº¦</label>
                            <div class="input-group">
                                <input type="number" step="any" class="form-control" id="lat" placeholder="ç·¯åº¦" required>
                                <input type="number" step="any" class="form-control" id="lng" placeholder="ç¶“åº¦" required>
                                <button type="button" class="btn btn-success" onclick="getGeo()">ğŸ“ å®šä½</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åœ°é» UUID (Client ID)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="locUuid" readonly>
                                <button class="btn btn-outline-success" type="button" onclick="genUUID('locUuid')">åˆ·æ–°</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100">å»ºç«‹åœ°é»ä¸¦é€£çµ (PUT)</button>
                    </form>
                    <div id="locResult" class="mt-3 d-none">
                        <div class="alert alert-success py-2">åœ°é»å»ºç«‹æˆåŠŸï¼å·²é€£çµè‡³çµ„ç¹”ã€‚</div>
                        <pre id="locJson"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const FHIR_BASE = "https://hapi.fhir.org/baseR4";

    // åˆå§‹åŒ–ï¼šç”¢ç”Ÿå…©çµ„ UUID
    window.onload = function() {
        genUUID('orgUuid');
        genUUID('locUuid');
    };

    function genUUID(elementId) {
        document.getElementById(elementId).value = crypto.randomUUID();
    }

    function getGeo() {
        if(!navigator.geolocation) return alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        navigator.geolocation.getCurrentPosition(p => {
            document.getElementById('lat').value = p.coords.latitude;
            document.getElementById('lng').value = p.coords.longitude;
        });
    }

    // 1. è™•ç†çµ„ç¹”ä¸Šå‚³
    document.getElementById('orgForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('orgUuid').value;
        const name = document.getElementById('orgName').value;

        const orgResource = {
            "resourceType": "Organization",
            "id": id,
            "active": true,
            "name": name,
            "type": [{ "coding": [{ "system": "http://terminology.hl7.org/CodeSystem/organization-type", "code": "prov" }] }]
        };

        await sendToFhir(id, 'Organization', orgResource, 'orgResult', 'orgJson');
        
        // è‡ªå‹•å¡«å…¥åœ°é»è¡¨å–®
        document.getElementById('linkOrgUuid').value = `Organization/${id}`;
    });

    // 2. è™•ç†åœ°é»ä¸Šå‚³ (åŒ…å«é—œè¯)
    document.getElementById('locForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('locUuid').value;
        const name = document.getElementById('locName').value;
        const orgRef = document.getElementById('linkOrgUuid').value;
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);

        if (!orgRef) {
            alert("è«‹å…ˆå®Œæˆæ­¥é©Ÿ 1 å»ºç«‹çµ„ç¹”ï¼");
            return;
        }

        const locResource = {
            "resourceType": "Location",
            "id": id,
            "status": "active",
            "name": name,
            "mode": "instance",
            // é€™æ˜¯æ‚¨è¦æ±‚çš„æ¨™æº–é—œè¯æ¬„ä½
            "managingOrganization": {
                "reference": orgRef,
                "display": document.getElementById('orgName').value
            },
            "position": {
                "longitude": lng,
                "latitude": lat
            }
        };

        await sendToFhir(id, 'Location', locResource, 'locResult', 'locJson');
    });

    // é€šç”¨ç™¼é€å‡½å¼
    async function sendToFhir(id, type, resource, resultDivId, jsonPreId) {
        const resultDiv = document.getElementById(resultDivId);
        const jsonPre = document.getElementById(jsonPreId);
        
        try {
            const url = `${FHIR_BASE}/${type}/${id}`;
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/fhir+json' },
                body: JSON.stringify(resource)
            });

            const data = await res.json();
            
            resultDiv.classList.remove('d-none');
            jsonPre.textContent = JSON.stringify(data, null, 2); // é¡¯ç¤ºä¼ºæœå™¨å›å‚³çš„ç¢ºèªè³‡æ–™

            if(!res.ok) throw new Error(data.issue?.[0]?.diagnostics || res.statusText);

        } catch (err) {
            alert(`ä¸Šå‚³å¤±æ•—: ${err.message}`);
        }
    }
</script>

</body>
</html>